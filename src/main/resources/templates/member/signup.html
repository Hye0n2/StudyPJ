<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입 - My Shop</title>
    
    <!-- (CSS 링크들은 그대로 둠) -->
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/footer.css}">
    <link rel="stylesheet" th:href="@{/css/form.css}">
    <link rel="stylesheet" th:href="@{/css/auth.css}">
    <link rel="stylesheet" th:href="@{/css/chatbot.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        .field-error { color: #d9534f; font-size: 0.9rem; font-weight: 500; margin-top: 5px; }
        .check-message { font-size: 0.9rem; font-weight: 500; margin-top: 5px; }
        .check-success { color: green; }
        .check-error { color: #d9534f; }
    </style>
</head>
<body>

    <!-- === 1. 헤더 부품 불러오기 === -->
    <div th:replace="~{fragments/header :: headerFragment}"></div>

    <!-- === 메인 콘텐츠 (회원가입 폼) === -->
    <main class="main-content">
        <div class="container">
            <div class="form-wrapper" style="max-width: 550px;">
                <h1>회원가입</h1>
                
                <form th:action="@{/user/signup}" method="post" th:object="${userCreateForm}" id="signupForm" novalidate>
                    
                    <!-- (서버) 전체 에러 알림창 -->
                    <div th:if="${#fields.hasGlobalErrors()}">
                        <div class="field-error" style="background-color: #fdd; padding: 10px; border-radius: 4px; margin-bottom: 20px;" 
                             th:each="err : ${#fields.globalErrors()}" th:text="${err}">
                            전체 오류 메시지
                        </div>
                    </div>

                    <!-- 아이디 (중복확인) -->
                    <div class="form-group">
                        <label for="username">아이디</label>
                        <div class="duplicate-check-group">
                            <input type="text" id="username" th:field="*{username}" class="form-control" placeholder="6~20자 영문 소문자, 숫자"
                                   minlength="6" maxlength="20"
                                   pattern="[a-z0-9]+"
                                   title="아이디는 6~20자의 영문 소문자와 숫자만 사용 가능합니다.">
                            <button type="button" class="btn btn-secondary" id="btn-check-username">중복확인</button>
                        </div>
                        <div id="username-check-msg" class="check-message"></div>
                        <div id="username-client-error" class="field-error"></div>
                        <div class="field-error" th:if="${#fields.hasErrors('username')}" th:errors="*{username}"></div>
                    </div>
                    
                    <!-- 비밀번호 -->
                    <div class="form-group">
                        <label for="password">비밀번호</label>
                        <input type="password" id="password" th:field="*{password}" class="form-control"
                               minlength="9" maxlength="24"
                               title="비밀번호는 9~24자 이내, 영문 대/소문자, 숫자, 특수문자 중 3가지 이상을 조합해야 합니다.">
                        <div id="password-client-error" class="field-error"></div>
                        <div class="field-error" th:if="${#fields.hasErrors('password')}" th:errors="*{password}"></div>
                    </div>
                    
                    <!-- 비밀번호 확인 -->
                    <div class="form-group">
                        <label for="password_confirm">비밀번호 확인</label>
                        <input type="password" id="password_confirm" th:field="*{password_confirm}" class="form-control">
                        <div id="password-check-msg" class="check-message"></div>
                        <div id="password_confirm-client-error" class="field-error"></div>
                        <div class="field-error" th:if="${#fields.hasErrors('password_confirm')}" th:errors="*{password_confirm}"></div>
                    </div>

                    <!-- 이름 -->
                    <div class="form-group">
                        <label for="name">이름</label>
                        <input type="text" id="name" th:field="*{name}" class="form-control">
                        <div id="name-client-error" class="field-error"></div>
                        <div class="field-error" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></div>
                    </div>

                    <!-- 닉네임 (중복확인) -->
                    <div class="form-group">
                        <label for="nickname">닉네임</label>
                        <div class="duplicate-check-group">
                            <input type="text" id="nickname" th:field="*{nickname}" class="form-control" placeholder="닉네임">
                            <button type="button" class="btn btn-secondary" id="btn-check-nickname">중복확인</button>
                        </div>
                        <div id="nickname-check-msg" class="check-message"></div>
                        <div id="nickname-client-error" class="field-error"></div>
                        <div class="field-error" th:if="${#fields.hasErrors('nickname')}" th:errors="*{nickname}"></div>
                    </div>
                    
                    <!-- 휴대폰 번호 -->
                    <div class="form-group">
                        <label for="phone">휴대폰 번호</label>
                        <input type="number" id="phone" th:field="*{phone}" class="form-control" placeholder="'-' (하이픈) 없이 10~11자리 숫자"
                               title="휴대폰 번호는 10~11자리의 숫자만 입력해주세요.">
                        <div id="phone-client-error" class="field-error"></div>
                        <div class="field-error" th:if="${#fields.hasErrors('phone')}" th:errors="*{phone}"></div>
                    </div>

                    <!-- 주소 폼 -->
                    <div class="form-group address-group">
                        <label for="zipcode">우편번호</label>
                        <div class="address-search">
                            <input type="text" id="zipcode" th:field="*{zipcode}" class="form-control" placeholder="우편번호" readonly>
                            <button type="button" class="btn btn-secondary" id="btn-search-address-signup">주소 검색</button>
                        </div>
                        <div id="zipcode-client-error" class="field-error"></div>
                        <div class="field-error" th:if="${#fields.hasErrors('zipcode')}" th:errors="*{zipcode}"></div>
                    </div>
                    <div class="form-group">
                        <label for="address1">주소</label>
                        <input type="text" id="address1" th:field="*{address1}" class="form-control" placeholder="주소" readonly>
                        <div id="address1-client-error" class="field-error"></div>
                        <div class="field-error" th:if="${#fields.hasErrors('address1')}" th:errors="*{address1}"></div>
                    </div>
                    <div class="form-group">
                        <label for="address2">상세주소</label>
                        <input type="text" id="address2" th:field="*{address2}" class="form-control" placeholder="상세주소를 입력하세요.">
                    </div>
                    
                    <!-- 이메일 폼 -->
                    <div class="form-group">
                        <label for="email_local">이메일</label>
                        <input type="hidden" id="email" th:field="*{email}">
                        <div class="email-group">
                            <input type="text" id="email_local" class="form-control" placeholder="이메일 아이디">
                            <span class="email-at">@</span>
                            <input type="text" id="email_domain_input" class="form-control" placeholder="직접 입력" value=""> 
                            <select id="email_domain_select" class="form-control">
                                <option value="direct" selected>직접 입력</option> 
                                <option value="naver.com">naver.com</option>
                                <option value="gmail.com">gmail.com</option>
                                <option value="daum.net">daum.net</option>
                                <option value="yahoo.com">yahoo.com</option>
                            </select>
                        </div>
                        <div id="email_local-client-error" class="field-error"></div>
                        <div class="field-error" th:if="${#fields.hasErrors('email')}" th:errors="*{email}"></div>
                    </div>

                    <!-- 자동방지문자 -->
                    <div class="form-group captcha-wrapper">
                        <label for="captcha_input">자동가입방지</label>
                        <div class="captcha-display-area">
                            <div class="captcha-text">
                                <span th:text="${captchaText}">AB123</span>
                                <div class="captcha-line"></div>
                            </div>
                            <div class="captcha-actions">
                                <button type="button" class="btn-icon" id="btn-captcha-refresh" title="새로고침"><i class="fas fa-sync-alt"></i></button>
                                <button type="button" class="btn-icon" id="btn-captcha-audio" title="음성듣기"><i class="fas fa-volume-up"></i></button>
                            </div>
                        </div>
                        
                        <!-- ★★★ (수정) 무조건 대문자 입력 설정 ★★★ -->
                        <!-- style: 눈에 보이는 것만 대문자로 / oninput: 실제 값도 대문자로 변환 -->
                        <input type="text" id="captcha_input" th:field="*{captcha_input}" class="form-control" 
                               placeholder="위의 문자를 입력하세요"
                               style="text-transform: uppercase;"
                               oninput="this.value = this.value.toUpperCase()">
                               
                        <div id="captcha_input-client-error" class="field-error"></div>
                        <div class="field-error" th:if="${#fields.hasErrors('captcha_input')}">자동방지문자 에러</div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-full">가입하기</button>
                    
                </form>
            </div>
        </div>
    </main>

    <!-- === 2. 푸터 부품 불러오기 === -->
    <div th:replace="~{fragments/footer :: footerFragment}"></div>
    
    <!-- === 3. 챗봇 부품 불러오기 === -->
    <div th:replace="~{fragments/footer :: chatbotFragment}"></div>
    
    <!-- === 4. 카테고리 사이드바 부품 불러오기 === -->
    <div th:replace="~{fragments/header :: categorySidebarFragment}"></div>
    
    <!-- === 5. 페이지 전용 스크립트 === -->
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script th:inline="javascript">
        
        // --- 캡챠(CAPTCHA) 기능 ---
        const captchaTextBox = document.querySelector(".captcha-text span");
        const captchaLine = document.querySelector(".captcha-line");
        function updateCaptchaStyle() {
            const randomRotation = Math.floor(Math.random() * 10) - 5;
            const randomTop = Math.floor(Math.random() * 20) + 40; 
            if(captchaLine) {
                captchaLine.style.setProperty('transform', `rotate(${randomRotation}deg)`);
                captchaLine.style.setProperty('top', `${randomTop}%`);
            }
        }
        const btnRefresh = document.getElementById("btn-captcha-refresh");
        if(btnRefresh) {
            btnRefresh.addEventListener("click", function() {
                if (window.speechSynthesis) window.speechSynthesis.cancel();
                fetch("/user/captcha-refresh", { method: "GET" })
                .then(response => response.json())
                .then(data => {
                    if(captchaTextBox) captchaTextBox.textContent = data.captchaText;
                    updateCaptchaStyle();
                })
                .catch(err => console.error("캡챠 새로고침 실패:", err));
            });
        }
        const btnAudio = document.getElementById("btn-captcha-audio");
        if(btnAudio) {
            btnAudio.addEventListener("click", function() {
                if (window.speechSynthesis) window.speechSynthesis.cancel(); 
                const textToSpeak = captchaTextBox.textContent;
                if (window.speechSynthesis) {
                    const utterance = new SpeechSynthesisUtterance(textToSpeak);
                    utterance.lang = 'en-US';
                    utterance.rate = 0.7;
                    window.speechSynthesis.speak(utterance);
                } else {
                    alert("현재 브라우저에서는 음성듣기 기능을 지원하지 않습니다.");
                }
            });
        }
        
        // --- 주소 검색 ---
        const btnSearchAddress = document.getElementById("btn-search-address-signup");
        if(btnSearchAddress) {
            btnSearchAddress.addEventListener("click", function(){
                new daum.Postcode({
                    oncomplete: function(data) {
                        document.getElementById("zipcode").value = data.zonecode;
                        document.getElementById("address1").value = data.address;
                        document.getElementById("address2").focus();
                    }
                }).open();
            });
        }

        // --- 음성 중지 및 초기화 ---
        window.onload = function() {
            if (window.speechSynthesis) window.speechSynthesis.cancel();
            updateCaptchaStyle(); 
            updateEmailField();
        };
        window.addEventListener('beforeunload', function() {
            if (window.speechSynthesis) window.speechSynthesis.cancel();
        });

        // --- 이메일 폼 조합 스크립트 ---
        const emailHidden = document.getElementById('email');
        const emailLocal = document.getElementById('email_local');
        const emailDomainSelect = document.getElementById('email_domain_select');
        const emailDomainInput = document.getElementById('email_domain_input');

        function updateEmailField() {
            const local = emailLocal.value;
            const domain = emailDomainInput.value; 
            if (local && domain) {
                emailHidden.value = local + '@' + domain;
            } else {
                emailHidden.value = ''; 
            }
        }
        emailDomainSelect.addEventListener('change', function() {
            const selectedValue = this.value;
            if (selectedValue === 'direct') {
                emailDomainInput.value = ''; 
                emailDomainInput.readOnly = false;
                emailDomainInput.placeholder = "직접 입력";
                emailDomainInput.focus();
            } else {
                emailDomainInput.value = selectedValue; 
                emailDomainInput.readOnly = true;
            }
            updateEmailField(); 
        });
        emailLocal.addEventListener('input', updateEmailField);
        emailDomainInput.addEventListener('input', updateEmailField);


        // --- 아이디/닉네임 중복 검사 ---
        function checkDuplicate(checkType, inputElement, msgElement) {
            const clientErrorMsg = document.getElementById(checkType + '-client-error');
            if(clientErrorMsg) clientErrorMsg.textContent = '';
            const value = inputElement.value;
            
            if (!value || value.trim().length < 4) {
                msgElement.textContent = (checkType === 'username' ? '아이디' : '닉네임') + "는 4자 이상 입력해주세요.";
                msgElement.className = "check-message check-error";
                return;
            }
            
            fetch(`/user/check/${checkType}?value=${value}`)
                .then(response => response.json())
                .then(data => {
                    if (data.available) {
                        msgElement.textContent = "사용 가능한 " + (checkType === 'username' ? '아이디' : '닉네임') + "입니다.";
                        msgElement.className = "check-message check-success";
                    } else {
                        msgElement.textContent = "이미 사용중인 " + (checkType === 'username' ? '아이디' : '닉네임') + "입니다.";
                        msgElement.className = "check-message check-error";
                    }
                })
                .catch(err => {
                    console.error("중복 검사 실패:", err);
                    msgElement.textContent = "중복 검사 중 오류가 발생했습니다.";
                    msgElement.className = "check-message check-error";
                });
        }
        document.getElementById('btn-check-username').addEventListener('click', function() {
            checkDuplicate('username', document.getElementById('username'), document.getElementById('username-check-msg'));
        });
        document.getElementById('btn-check-nickname').addEventListener('click', function() {
            checkDuplicate('nickname', document.getElementById('nickname'), document.getElementById('nickname-check-msg'));
        });


        // --- 비밀번호 일치 실시간 검사 ---
        const passwordInput = document.getElementById('password');
        const passwordConfirmInput = document.getElementById('password_confirm');
        const passwordCheckMsg = document.getElementById('password-check-msg');

        function checkPasswordMatch() {
            const clientErrorMsg = document.getElementById('password_confirm-client-error');
            if(clientErrorMsg) clientErrorMsg.textContent = '';
            const password = passwordInput.value;
            const confirmPassword = passwordConfirmInput.value;

            if (confirmPassword === "") {
                passwordCheckMsg.textContent = ""; 
                passwordCheckMsg.className = "check-message";
                return;
            }

            if (password === confirmPassword) {
                passwordCheckMsg.textContent = "비밀번호가 일치합니다.";
                passwordCheckMsg.className = "check-message check-success";
            } else {
                passwordCheckMsg.textContent = "비밀번호가 틀립니다.";
                passwordCheckMsg.className = "check-message check-error";
            }
        }
        passwordInput.addEventListener('keyup', checkPasswordMatch);
        passwordConfirmInput.addEventListener('keyup', checkPasswordMatch);


        // --- 폼 제출 시 유효성 검사 ---
        const form = document.getElementById('signupForm');
        
        form.addEventListener('submit', function(event) {
            
            document.querySelectorAll('.check-message, [id$="-client-error"]').forEach(el => el.textContent = '');

            const fieldsToValidate = [
                { id: 'username', label: '아이디', regex: /^[a-z0-9]{6,20}$/, msg: "아이디는 6~20자 영문 소문자와 숫자만 사용 가능합니다." },
                { id: 'password', label: '비밀번호', regex: /^.{9,24}$/, msg: "비밀번호는 9자 이상 24자 이하로 입력해주세요." },
                { id: 'password_confirm', label: '비밀번호 확인' },
                { id: 'name', label: '이름' },
                { id: 'nickname', label: '닉네임' },
                { id: 'phone', label: '휴대폰 번호', regex: /^[0-9]{10,11}$/, msg: "휴대폰 번호는 10~11자리의 숫자만 입력해주세요." },
                { id: 'zipcode', label: '우편번호' },
                { id: 'address1', label: '주소' },
                { id: 'email_local', label: '이메일' },
                { id: 'captcha_input', label: '자동가입방지 문자' }
            ];

            for (const field of fieldsToValidate) {
                const inputElement = document.getElementById(field.id);
                const errorElement = document.getElementById(field.id + '-client-error');
                
                if (!inputElement.value || inputElement.value.trim() === '') {
                    event.preventDefault(); 
                    if (errorElement) errorElement.textContent = field.label + '은(는) 필수 항목입니다.';
                    inputElement.focus();
                    return; 
                }
                
                if (field.regex && !field.regex.test(inputElement.value)) {
                    event.preventDefault(); 
                    if (errorElement) errorElement.textContent = field.msg;
                    inputElement.focus();
                    return;
                }
            }
            
            if (emailDomainSelect.value === 'direct' && (!emailDomainInput.value || emailDomainInput.value.trim() === '')) {
                event.preventDefault(); 
                const errorElement = document.getElementById('email_local-client-error');
                if (errorElement) errorElement.textContent = '이메일 도메인을 직접 입력해주세요.';
                emailDomainInput.focus();
                return;
            }
        });

    </script>
</body>
</html>